name: PureStack Audit System

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  audit-dotnet:
    runs-on: ubuntu-latest
    name: ğŸ‘® PureStack Quality Gate

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Phase 1: Structural Integrity
        run: |
          echo "::group::File Validation"
          # Critical: The solution must exist
          if [ ! -f "PureStackLogistics.sln" ]; then echo "âŒ Missing Solution File"; exit 1; fi
          
          # Critical: The service to implement must exist
          if [ ! -f "src/PureStackLogistics/Services/InventoryService.cs" ]; then echo "âŒ Missing InventoryService.cs"; exit 1; fi
          
          echo "âœ… Project Structure seems valid."
          echo "::endgroup::"

      - name: ğŸ”§ Setup .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: ğŸ“¦ Restore Dependencies
        run: dotnet restore

      - name: ğŸ•µï¸ Phase 2: Anti-Pattern Detection
        run: |
          echo "::group::Static Analysis"
          # Ban synchronous blocking on Tasks (Crucial for Level 1)
          if grep -r --include="*.cs" "\.Result" src/; then
            echo "âŒ CRITICAL: Blocking call '.Result' detected. Use 'await' instead."
            exit 1
          fi
          if grep -r --include="*.cs" "\.Wait(" src/; then
            echo "âŒ CRITICAL: Blocking call '.Wait()' detected. Use 'await' instead."
            exit 1
          fi
          if grep -r --include="*.cs" "Thread.Sleep" src/; then
            echo "âŒ CRITICAL: 'Thread.Sleep' detected. Use 'Task.Delay' instead."
            exit 1
          fi
          echo "âœ… No major anti-patterns detected."
          echo "::endgroup::"

      - name: ğŸ—ï¸ Phase 3: Architecture Scout (Level 2 Check)
        # This step doesn't fail the build, but informs the reviewer
        run: |
          echo "::group::Architecture Capability Scan"
          INTERFACE_COUNT=$(find src/PureStackLogistics -name "I*Repository.cs" | wc -l)
          CLASS_COUNT=$(find src/PureStackLogistics -name "*Repository.cs" | wc -l)
          
          if [ "$INTERFACE_COUNT" -gt 0 ]; then
            echo "ğŸ† PRO LEVEL DETECTED: Candidate implemented $INTERFACE_COUNT Interface(s)."
          else
            echo "â„¹ï¸ Basic Level: No Repository Interfaces found."
          fi
          
          if [ "$CLASS_COUNT" -gt 0 ]; then
            echo "ğŸ† PRO LEVEL DETECTED: Candidate implemented $CLASS_COUNT Repository Class(es)."
          fi
          echo "::endgroup::"

      - name: ğŸ—ï¸ Build Project
        run: dotnet build --no-restore

      - name: ğŸ§ª Phase 4: Functional Validation
        # Enforce strict passing of tests
        run: dotnet test --no-build --verbosity normal
